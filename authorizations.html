<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Autorizaciones de Pedidos</title>

    <!-- ✅ Carga correcta de Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap">

    <style>
        :root {
            --primary: #1e67d2;
            --dark: #3c3c3c;
            --muted: #666;
            --border: #d9d9d9;
            --bg: #fff;
            --shadow: rgba(0, 0, 0, 0.25);
            --thead-bg: #cfa06a;
            --thead-text: #0b1a30;
            --thead-border: #0b1a30;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            margin: 16px;
            color: #222;
        }

        /* Barra superior */
        header {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 999px;
            padding: 8px 12px;
            border: 1px solid transparent;
            cursor: pointer;
            font-size: 14px;
            transition: transform .05s ease-in-out;
            background: #f7f7f7;
            color: #333;
        }

        .icon-btn .material-icons {
            font-size: 18px;
        }

        .icon-btn:hover {
            transform: translateY(-1px);
        }

        .icon-btn.back {
            background: #f0f2f6;
            color: #0b1a30;
            border-color: #e6e8ed;
        }

        .icon-btn.primary {
            background: var(--primary);
            color: #fff;
        }

        .icon-btn.dark {
            background: var(--dark);
            color: #fff;
        }

        .badge {
            margin-left: 8px;
            min-width: 20px;
            padding: 0 6px;
            border-radius: 999px;
            background: #fff;
            color: #1e67d2;
            font-weight: 600;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            display: none;
        }

        h2 {
            margin: 0 0 10px;
            text-transform: uppercase;
            letter-spacing: .3px;
            font-weight: 700;
        }

        .meta {
            color: var(--muted);
            font-size: .95em;
            margin: 2px 0 10px;
        }

        .meta strong {
            color: #222;
        }

        .bar {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin: 6px 0 8px;
        }

        label.inline {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* Tabla estilo impresión */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        thead th {
            background: var(--thead-bg);
            color: var(--thead-text);
            font-weight: 600;
            border-bottom: 2px solid var(--thead-border);
            border-top: 2px solid var(--thead-border);
            padding: 8px 6px;
        }

        tbody td {
            border: 1px solid var(--border);
            padding: 6px;
            font-size: 13px;
            vertical-align: middle;
        }

        td.num {
            text-align: right;
            white-space: nowrap;
        }

        td.center {
            text-align: center;
        }

        .empty {
            padding: 12px;
            background: #fafafa;
            border: 1px dashed var(--border);
            border-radius: 8px;
            margin-top: 8px;
        }

        /* Modal “mensaje emergente” */
        .backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.30);
            backdrop-filter: blur(1px);
            z-index: 2000;
        }

        .backdrop.show {
            display: block;
        }

        .dialog {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: min(640px, 92vw);
            max-height: 85vh;
            overflow: auto;
            background: var(--bg);
            border-radius: 12px;
            box-shadow: 0 10px 32px var(--shadow);
            padding: 16px;
            z-index: 2001;
        }

        .dialog.show {
            display: block;
        }

        .dialog h3 {
            margin: 0 0 8px;
            font-weight: 700;
        }

        .dialog .subtitle {
            color: var(--muted);
            margin-bottom: 12px;
            font-size: 14px;
        }

        .dialog .row {
            margin: 8px 0;
        }

        .dialog input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .dialog .actions {
            display: flex;
            gap: 8px;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        .dialog .btn {
            border: 0;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .dialog .btn.primary {
            background: var(--primary);
            color: #fff;
        }

        .dialog .btn.secondary {
            background: #eee;
            color: #333;
        }

        .dialog .btn[disabled] {
            opacity: .6;
            cursor: not-allowed;
        }

        .dialog .material-icons {
            font-size: 20px;
            vertical-align: middle;
            margin-right: 6px;
        }

        details {
            margin-top: 6px;
        }

        ul {
            margin: 8px 0 0;
            padding-left: 18px;
        }

        .muted {
            color: var(--muted);
        }

        /* Overlay “Procesando…” + Toast */
        .busy {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 2100;
            background: rgba(255, 255, 255, 0.85);
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 14px;
            color: #222;
        }

        .busy.show {
            display: flex;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #ddd;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
            margin: 8px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 16px;
            z-index: 2200;
            background: #333;
            color: #fff;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }

        .toast.show {
            display: block;
        }
    </style>
</head>

<body>

    <!-- Barra superior -->
    <header>
        <button class="icon-btn back" id="btnBack">
            <span class="material-icons" aria-hidden="true">arrow_back</span>
            <span>Volver</span>
        </button>

        <button class="icon-btn primary" id="btnOpenAuthorize">
            <span class="material-icons" aria-hidden="true">done_all</span>
            <span>Autorizar Pedidos</span>
            <span id="pendingBadge" class="badge"></span>
        </button>

        <button class="icon-btn dark" id="btnPrint">
            <span class="material-icons" aria-hidden="true">print</span>
            <span>Imprimir</span>
        </button>
    </header>

    <h2>Autorizaciones de Pedidos</h2>

    <div class="meta">
        <div><strong>FECHA:</strong> <span id="hoy"></span></div>
        <div><strong>Firma/s autorizada/s:</strong> <span class="muted">(se solicitarán al confirmar)</span></div>
    </div>

    <!-- Selección y totales -->
    <div class="bar">
        <label class="inline"><input type="checkbox" id="chkAll"> Seleccionar todo (columna “SI”)</label>
        <div class="muted" style="margin-left:auto;">Pendientes: <strong><span id="lblTotal">0</span></strong> —
            Seleccionados: <strong><span id="lblSel">0</span></strong></div>
    </div>

    <div id="emptyBox" class="empty" style="display:none;">No hay pedidos pendientes de autorización.</div>

    <!-- Tabla estilo original (AUTORIZADO con SI/NO) -->
    <table id="tbl" aria-label="Pedidos pendientes">
        <thead>
            <tr>
                <th>Proveedor</th>
                <th>Descripción</th>
                <th>Fecha Pedido</th>
                <th>Comprador</th>
                <th>Medio pedido</th>
                <th>Edificio</th>
                <th>Solicitante</th>
                <th>GDC</th>
                <th colspan="2" class="center">AUTORIZADO</th>
                <th class="num">Importe s/iva</th>
            </tr>
            <tr>
                <th colspan="8"></th>
                <th class="center">SI</th>
                <th class="center">NO</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="tbody">
            <!-- Se rellena por JS -->
        </tbody>
    </table>

    <!-- Modal “¿Autorizar Pedidos?” -->
    <div id="backdrop" class="backdrop" aria-hidden="true"></div>
    <div id="dialog" class="dialog" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
        <h3 id="dlgTitle"><span class="material-icons" aria-hidden="true">verified_user</span> ¿Autorizar Pedidos?</h3>
        <div class="subtitle">
            <div>Seleccionados: <strong><span id="cntSel">0</span></strong> / Pendientes: <strong><span
                        id="cntTot">0</span></strong></div>
            <div>Se marcarán como autorizados un total de <strong><span id="cntConfirm">0</span></strong> pedido(s).
            </div>
            <div><em>Esta acción quedará registrada.</em></div>
        </div>

        <div class="row">
            <label for="firmas"><strong>Firma/s autorizada/s</strong></label>
            <input id="firmas" type="text" placeholder="Nombre(s) de quien autoriza">
        </div>

        <details>
            <summary>Ver detalle de la selección</summary>
            <ul id="selList">
                <li class="muted">Sin selección.</li>
            </ul>
        </details>

        <div class="actions">
            <!-- Contador + Total integrados en el botón -->
            <button class="btn primary" id="btnConfirmSelected" disabled>
                Autorizar seleccionados (<span id="btnSelCount">0</span>) — Total: <span id="btnSelTotal">€0,00</span>
            </button>
            <button class="btn" id="btnConfirmAll" disabled>Sí, Autorizar todos</button>
            <button class="btn secondary" id="btnCancel">Cancelar</button>
        </div>
    </div>

    <!-- Overlay “Procesando…” + Toast -->
    <div id="busy" class="busy" aria-hidden="true">
        <div>
            <div>Procesando autorización…</div>
            <div class="spinner" role="progressbar" aria-label="Cargando"></div>
        </div>
    </div>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- Variables inyectadas desde doGet (opcional) -->
    <script>
        const APP_URL = <?!= JSON.stringify(appUrl || '') ?>;
        const ORDERS_PAGE = <?!= JSON.stringify(ordersPage || 'dashboard') ?>;
    </script>

    <script>
        (function () {
            /* Estado */
            const state = { rows: [], selected: new Set() };

            /* Refs */
            const elHoy = document.getElementById('hoy');
            const lblTotal = document.getElementById('lblTotal');
            const lblSel = document.getElementById('lblSel');
            const tbody = document.getElementById('tbody');
            const emptyBox = document.getElementById('emptyBox');
            const chkAll = document.getElementById('chkAll');
            const badge = document.getElementById('pendingBadge');

            // ===== Barra superior =====
            document.getElementById('btnBack').addEventListener('click', function () {
                google.script.run
                    .withSuccessHandler(function (url) {
                        if (url && typeof url === 'string' && url.length) {
                            window.top.location.href = url;
                            return;
                        }
                        const base = (window.top && window.top.location) ? window.top.location : window.location;
                        const target = base.origin + base.pathname + (base.search ? base.search + '&' : '?') + 'page=' + encodeURIComponent(ORDERS_PAGE);
                        window.location.href = target;
                    })
                    .getOrdersListUrl();
            });

            document.getElementById('btnPrint').addEventListener('click', () => window.print());
            document.getElementById('btnOpenAuthorize').addEventListener('click', openDialog);

            // ===== Modal refs =====
            const dlg = document.getElementById('dialog');
            const backdrop = document.getElementById('backdrop');
            const btnCancel = document.getElementById('btnCancel');
            const btnSel = document.getElementById('btnConfirmSelected');
            const btnAll = document.getElementById('btnConfirmAll');
            const cntSelEl = document.getElementById('cntSel');
            const cntTotEl = document.getElementById('cntTot');
            const cntConfirmEl = document.getElementById('cntConfirm');
            const selList = document.getElementById('selList');
            const firmasEl = document.getElementById('firmas');
            const btnSelCount = document.getElementById('btnSelCount');
            const btnSelTotal = document.getElementById('btnSelTotal');

            btnCancel.addEventListener('click', closeDialog);
            backdrop.addEventListener('click', closeDialog);

            // ===== Busy + Toast =====
            const busy = document.getElementById('busy');
            const toast = document.getElementById('toast');
            function showBusy(on = true) { busy.classList.toggle('show', on); }
            function showToast(msg, ms = 2200) { toast.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), ms); }

            // ===== Utilidades de importe y formato =====
            const currencyEs = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });
            function parseImporte(val) {
                if (val == null || val === '') return 0;
                if (typeof val === 'number') return val;
                const s = String(val).trim();
                const normalized = s.replace(/\./g, '').replace(',', '.'); // miles y coma decimal
                const n = parseFloat(normalized);
                return isNaN(n) ? 0 : n;
            }
            function computeSelectionTotals() {
                let total = 0;
                const ids = Array.from(state.selected);
                if (!ids.length) return { count: 0, total: 0 };
                const byId = new Map(state.rows.map(r => [String(r['Id_Pedido'] || ''), r]));
                ids.forEach(id => {
                    const r = byId.get(String(id));
                    if (r) total += parseImporte(r['Importe']);
                });
                return { count: ids.length, total };
            }

            // ===== Habilitación de botones según firmas + selección =====
            function updateButtonsEnabled() {
                const hasFirmas = !!(firmasEl && firmasEl.value.trim());
                const selTotals = computeSelectionTotals();
                btnSel.disabled = !(hasFirmas && selTotals.count > 0);
                btnAll.disabled = !hasFirmas;
                if (btnSelCount) btnSelCount.textContent = String(selTotals.count);
                if (btnSelTotal) btnSelTotal.textContent = currencyEs.format(selTotals.total);
            }
            if (firmasEl) {
                firmasEl.addEventListener('input', updateButtonsEnabled);
            }

            // ===== Seleccionar todo (columna SI) =====
            chkAll.addEventListener('change', function (ev) {
                const check = ev.target.checked;
                const boxes = tbody.querySelectorAll('input[type="checkbox"][data-id][data-col="si"]');
                state.selected.clear();
                boxes.forEach(ch => {
                    ch.checked = check;
                    if (check) state.selected.add(ch.dataset.id);
                    const no = tbody.querySelector('input[type="checkbox"][data-id="' + ch.dataset.id + '"][data-col="no"]');
                    if (no) no.checked = !check && no.checked ? true : false;
                });
                updateSelectionSummary();
                updateButtonsEnabled();
            });

            // ===== Abrir/Cerrar diálogo =====
            function openDialog() {
                cntSelEl.textContent = state.selected.size;
                cntTotEl.textContent = state.rows.length;
                cntConfirmEl.textContent = state.selected.size > 0 ? state.selected.size : state.rows.length;

                if (state.selected.size) {
                    const selectedMap = new Map(state.rows.map(r => [String(r['Id_Pedido']), r]));
                    const items = Array.from(state.selected).map(id => {
                        const r = selectedMap.get(String(id)) || {};
                        const prov = r['Proveedor'] || '';
                        const desc = r['Descripción'] || '';
                        const imp = (r['Importe'] != null ? r['Importe'] : '');
                        // ⬇️ ID eliminado del detalle mostrado
                        return '<li><strong>' + escapeHTML(prov) + '</strong> — ' + escapeHTML(desc) + ' — Importe: ' + escapeHTML(imp) + '</li>';
                    });
                    selList.innerHTML = items.join('');
                } else {
                    selList.innerHTML = '<li class="muted">Sin selección.</li>';
                }

                updateButtonsEnabled();

                backdrop.classList.add('show');
                dlg.classList.add('show');
                firmasEl && firmasEl.focus();
            }
            function closeDialog() {
                dlg.classList.remove('show');
                backdrop.classList.remove('show');
            }

            // ===== Confirmar: seleccionados =====
            btnSel.addEventListener('click', function () {
                const firmas = (firmasEl && firmasEl.value.trim()) || '';
                if (!firmas) {
                    showToast('Introduce la firma antes de autorizar.', 2800);
                    firmasEl && (firmasEl.focus(), firmasEl.scrollIntoView({ behavior: 'smooth', block: 'center' }));
                    return;
                }
                const payload = { userAgent: navigator.userAgent, extras: firmas, firmas: firmas };
                const ids = Array.from(state.selected);
                if (!ids.length) return;

                btnSel.disabled = true; btnAll.disabled = true; showBusy(true);

                google.script.run
                    .withSuccessHandler(function (res) {
                        showBusy(false); closeDialog();
                        showToast('Autorizados (selección): ' + (res && res.count !== undefined ? res.count : 0));
                        loadData();
                    })
                    .withFailureHandler(function (err) {
                        showBusy(false); updateButtonsEnabled();
                        showToast('Error: ' + (err && err.message ? err.message : err), 3200);
                    })
                    .markOrdersAsAuthorized(ids, payload);
            });

            // ===== Confirmar: todos =====
            btnAll.addEventListener('click', function () {
                const firmas = (firmasEl && firmasEl.value.trim()) || '';
                if (!firmas) {
                    showToast('Introduce la firma antes de autorizar.', 2800);
                    firmasEl && (firmasEl.focus(), firmasEl.scrollIntoView({ behavior: 'smooth', block: 'center' }));
                    return;
                }
                const payload = { userAgent: navigator.userAgent, extras: firmas, firmas: firmas };

                btnSel.disabled = true; btnAll.disabled = true; showBusy(true);

                google.script.run
                    .withSuccessHandler(function (res) {
                        showBusy(false); closeDialog();
                        showToast('Autorizados (todos): ' + (res && res.count !== undefined ? res.count : 0));
                        loadData();
                    })
                    .withFailureHandler(function (err) {
                        showBusy(false); updateButtonsEnabled();
                        showToast('Error: ' + (err && err.message ? err.message : err), 3200);
                    })
                    .authorizeAllPendingOrders(payload);
            });

            // ===== Carga de datos =====
            function loadData() {
                try {
                    const hoy = new Date();
                    elHoy.textContent = hoy.toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit' });
                } catch (e) { }

                state.rows = [];
                state.selected.clear();
                tbody.innerHTML = '';
                lblTotal.textContent = '0';
                lblSel.textContent = '0';
                emptyBox.style.display = 'none';

                google.script.run
                    .withSuccessHandler(function (rows) {
                        state.rows = rows || [];
                        if (!state.rows.length) emptyBox.style.display = 'block';
                        renderRows(state.rows);
                        lblTotal.textContent = String(state.rows.length);
                        lblSel.textContent = String(state.selected.size);

                        // Badge en “Autorizar Pedidos”
                        if (badge) {
                            if (state.rows.length > 0) {
                                badge.textContent = state.rows.length;
                                badge.style.display = 'inline-block';
                            } else {
                                badge.style.display = 'none';
                            }
                        }
                    })
                    .withFailureHandler(function (err) {
                        emptyBox.style.display = 'block';
                        emptyBox.textContent = 'Error cargando pedidos: ' + (err && err.message ? err.message : err);
                    })
                    .getPendingOrders();
            }

            function renderRows(rows) {
                const frag = document.createDocumentFragment();
                rows.forEach(r => {
                    const tr = document.createElement('tr');
                    const id = String(r['Id_Pedido'] || '');

                    tr.appendChild(tdText(r['Proveedor']));      // Proveedor
                    tr.appendChild(tdText(r['Descripción']));    // Descripción
                    tr.appendChild(tdText(r['Fecha Pedido'] ? formatDate(r['Fecha Pedido']) : '')); // Fecha
                    tr.appendChild(tdText(r['Comprador']));      // Comprador
                    tr.appendChild(tdText(r['Medio Pedido']));   // Medio
                    tr.appendChild(tdText(r['Edificio']));       // Edificio
                    tr.appendChild(tdText(r['Solicitante']));    // Solicitante
                    tr.appendChild(tdText(r['GDC_PINV']));       // GDC

                    // AUTORIZADO - SI (selección)
                    const tdSi = document.createElement('td'); tdSi.className = 'center';
                    const chkSi = document.createElement('input'); chkSi.type = 'checkbox';
                    chkSi.setAttribute('data-id', id);
                    chkSi.setAttribute('data-col', 'si');
                    chkSi.addEventListener('change', function (ev) {
                        if (ev.target.checked) {
                            state.selected.add(id);
                            const no = tbody.querySelector('input[type="checkbox"][data-id="' + id + '"][data-col="no"]');
                            if (no) no.checked = false;
                        } else {
                            state.selected.delete(id);
                        }
                        updateSelectionSummary();
                        updateButtonsEnabled();
                    });
                    tdSi.appendChild(chkSi);
                    tr.appendChild(tdSi);

                    // AUTORIZADO - NO (visual)
                    const tdNo = document.createElement('td'); tdNo.className = 'center';
                    const chkNo = document.createElement('input'); chkNo.type = 'checkbox';
                    chkNo.setAttribute('data-id', id);
                    chkNo.setAttribute('data-col', 'no');
                    chkNo.addEventListener('change', function (ev) {
                        if (ev.target.checked) {
                            const si = tbody.querySelector('input[type="checkbox"][data-id="' + id + '"][data-col="si"]');
                            if (si) { si.checked = false; state.selected.delete(id); }
                        }
                        updateSelectionSummary();
                        updateButtonsEnabled();
                    });
                    tdNo.appendChild(chkNo);
                    tr.appendChild(tdNo);

                    tr.appendChild(tdNum(r['Importe']));         // Importe s/iva

                    frag.appendChild(tr);
                });
                tbody.innerHTML = '';
                tbody.appendChild(frag);
            }

            function tdText(val) { const td = document.createElement('td'); td.textContent = val == null ? '' : String(val); return td; }
            function tdNum(val) { const td = document.createElement('td'); td.className = 'num'; td.textContent = (val == null || val === '') ? '' : String(val); return td; }

            function updateSelectionSummary() {
                lblSel.textContent = String(state.selected.size);
                const total = state.rows.length;
                const sel = state.selected.size;
                chkAll.checked = (total > 0 && sel === total);
            }

            function formatDate(isoOrDateStr) {
                try {
                    const d = new Date(isoOrDateStr);
                    if (!isFinite(d)) return isoOrDateStr || '';
                    return d.toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit' });
                } catch (e) { return isoOrDateStr || ''; }
            }

            function escapeHTML(s) {
                s = String(s == null ? '' : s);
                return s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
            }

            // Inicial
            loadData();
        })();
    </script>

</body>

</html>