<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <?!= include('css'); ?>

    <!-- Fuentes correctamente enlazadas -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <script>
        const APP_URL = "<?= appUrl ?>";
    </script>

    <style>
        :root {
            --bg-color: #f3f4f6;
            --primary-color: #2563eb;
            --border-color: #ccc;

            /* alturas visuales del header en pantalla */
            --header-row1-height: 35px;
            --header-row2-height: 25px;

            /* colores de la tabla */
            --thead-bg: #d19f6a;
            /* naranja cabecera */
            --zebra-bg: #fcefe3;
            /* zebra */
        }

        /* ===== BASE / LAYOUT ===== */
        html,
        body {
            height: 100%;
            min-height: 0;
        }

        body {
            background-color: var(--bg-color);
            padding: 20px;
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 0;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .toolbar {
            max-width: 297mm;
            margin: 0 auto 20px auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 0 0 auto;
        }

        .btn-print {
            background: #374151;
            color: #fff;
            border: none;
        }

        .btn-primary,
        .btn-secondary,
        .btn-print {
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary {
            background: #fff;
            border: 1px solid #e5e7eb;
            color: #374151;
        }

        .btn-primary {
            background: #2563eb;
            color: #fff;
            border: none;
        }

        .btn-primary:hover {
            opacity: .9
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .paper-container {
            background: #fff;
            max-width: 297mm;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1);
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            min-height: 0;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
            color: #000;
            border-bottom: 2px solid #2563eb;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
            flex: 0 0 auto;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-weight: 600;
            flex: 0 0 auto;
        }

        .signature-box-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 16px;
            flex: 0 0 auto;
        }

        .signature-box {
            width: 250px;
            height: 100px;
            border: 1px solid #ccc;
            background-color: #f3f4f6;
        }

        .signature-label {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 5px;
            display: block;
            text-align: right;
        }

        /* ===== TABLA: HEADER FIJO + CUERPO SCROLL ===== */
        .table-wrapper {
            border: 1px solid var(--border-color);
            flex: 1 1 auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .header-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 11px;
            flex: 0 0 auto;
        }

        .body-scroll {
            flex: 1 1 auto;
            min-height: 0;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            /* Ajusta según tu layout */
            max-height: calc(100vh - 240px);
            /* Alternativa fija: height:550px; */
        }

        .body-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 11px;
        }

        /* Colgroup (ajusta si lo deseas) */
        .data-col-1 {
            width: 12%
        }

        .data-col-2 {
            width: 22%
        }

        .data-col-3 {
            width: 8%
        }

        .data-col-4 {
            width: 10%
        }

        .data-col-5 {
            width: 8%
        }

        .data-col-6 {
            width: 8%
        }

        .data-col-7 {
            width: 10%
        }

        .data-col-8 {
            width: 7%
        }

        .data-col-9 {
            width: 3%
        }

        .data-col-10 {
            width: 3%
        }

        .data-col-11 {
            width: 9%
        }

        /* Celdas base */
        .header-table th,
        .body-table td,
        .body-table thead th {
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            padding: 4px 8px;
            background: #fff;
            box-sizing: border-box;
        }

        .header-table th:last-child,
        .body-table td:last-child,
        .body-table thead th:last-child {
            border-right: none;
        }

        /* Cabeceras (pantalla) */
        .header-table th,
        .body-table thead th {
            background-color: var(--thead-bg);
            color: #000;
            font-weight: 700;
            text-align: left;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .header-table thead tr:first-child th,
        .body-table thead tr:first-child th {
            height: var(--header-row1-height);
            vertical-align: middle;
            border-bottom: 1px solid #7c5e3f;
        }

        .header-table thead tr:nth-child(2) th,
        .body-table thead tr:nth-child(2) th {
            height: var(--header-row2-height);
            vertical-align: middle;
            border-bottom: 1px solid #7c5e3f;
        }

        /* Zebra */
        .body-table td {
            z-index: 1;
        }

        .body-table tr:nth-child(even) td {
            background-color: var(--zebra-bg);
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        /* Oculto en pantalla, visible como cabecera repetida en impresión */
        .print-only {
            display: none;
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, .5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all .3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-card {
            background: #fff;
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .modal-icon {
            width: 48px;
            height: 48px;
            background-color: #e0f2fe;
            color: #0284c7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-modal {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            flex: 1;
        }

        .btn-cancel {
            background: #fff;
            border: 1px solid #ddd;
        }

        .btn-confirm {
            background: #2563eb;
            color: #fff;
        }

        /* ===== IMPRESIÓN (A4 Landscape a todo ancho, colores y header repetido) ===== */
        * {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 8mm;
            }

            /* márgenes pequeños */

            html,
            body {
                height: auto;
            }

            body,
            .paper-container {
                margin: 0;
                padding: 0;
                width: 100%;
                max-width: none;
                box-shadow: none;
                display: block;
            }

            /* Reduce padding interno para aprovechar el ancho */
            .paper-container {
                padding: 4mm 6mm;
            }

            /* Oculta elementos no imprimibles */
            .toolbar,
            .modal-overlay {
                display: none !important;
            }

            /* Sin scroll: imprime todo */
            .body-scroll {
                overflow: visible !important;
                max-height: none !important;
                height: auto !important;
            }

            /* Aprovecha el ancho total y bordes definidos */
            .table-wrapper {
                border: none;
            }

            .header-table,
            .body-table {
                table-layout: fixed;
                width: 100%;
                border-collapse: collapse;
            }

            /* Repite cabecera en cada página impresa:
         - Oculta la tabla de encabezado fija
         - Muestra el thead duplicado de la tabla del cuerpo */
            .header-table {
                display: none !important;
            }

            .print-only {
                display: table-header-group !important;
            }

            /* Reafirma colores por si el motor intenta desaturar */
            .body-table thead th {
                background-color: var(--thead-bg) !important;
                color: #000 !important;
            }

            .body-table tr:nth-child(even) td {
                background-color: var(--zebra-bg) !important;
            }

            /* (Opcional) grosor de bordes para papel */
            .body-table thead th,
            .body-table td {
                border-width: 1px;
                border-style: solid;
            }
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <button onclick="goBack()" class="btn-secondary">
            <span class="material-icons-round">arrow_back</span> Volver
        </button>
        <div style="display:flex;gap:10px;">
            <button id="btn-main-auth" onclick="openModal()" class="btn-primary" disabled>
                <span class="material-icons-round">done_all</span> Marcar Todo Autorizado
            </button>
            <button onclick="window.print()" class="btn-print">
                <span class="material-icons-round">print</span> Imprimir
            </button>
        </div>
    </div>

    <div class="paper-container">
        <h1>Autorizaciones de Pedidos</h1>

        <div class="header-row">
            <span></span>
            <span>FECHA: <span id="current-date"></span></span>
        </div>

        <div class="signature-box-container">
            <div style="width:250px;">
                <span class="signature-label">Firma/s autorizada/s:</span>
                <div class="signature-box"></div>
            </div>
        </div>

        <!-- Encabezado fijo + cuerpo con scroll -->
        <div class="table-wrapper">
            <!-- Tabla de encabezado (solo pantalla) -->
            <table class="header-table">
                <colgroup>
                    <col class="data-col-1">
                    <col class="data-col-2">
                    <col class="data-col-3">
                    <col class="data-col-4">
                    <col class="data-col-5">
                    <col class="data-col-6">
                    <col class="data-col-7">
                    <col class="data-col-8">
                    <col class="data-col-9">
                    <col class="data-col-10">
                    <col class="data-col-11">
                </colgroup>
                <thead>
                    <tr>
                        <th rowspan="2" style="vertical-align:middle;">Proveedor</th>
                        <th rowspan="2" style="vertical-align:middle;">Descripción</th>
                        <th rowspan="2" style="vertical-align:middle;">Fecha Pedido</th>
                        <th rowspan="2" style="vertical-align:middle;">Comprador</th>
                        <th rowspan="2" style="vertical-align:middle;">Medio pedido</th>
                        <th rowspan="2" style="vertical-align:middle;">Edificio</th>
                        <th rowspan="2" style="vertical-align:middle;">Solicitante</th>
                        <th rowspan="2" style="vertical-align:middle;">GDC</th>
                        <th colspan="2" class="text-center">AUTORIZADO</th>
                        <th rowspan="2" class="text-right" style="vertical-align:middle;">Importe<br>s/iva</th>
                    </tr>
                    <tr>
                        <th class="text-center">SI</th>
                        <th class="text-center">NO</th>
                    </tr>
                </thead>
            </table>

            <!-- Cuerpo con scroll (pantalla) + thead duplicado (solo impresión) -->
            <div class="body-scroll">
                <table class="body-table" id="orders-table">
                    <colgroup>
                        <col class="data-col-1">
                        <col class="data-col-2">
                        <col class="data-col-3">
                        <col class="data-col-4">
                        <col class="data-col-5">
                        <col class="data-col-6">
                        <col class="data-col-7">
                        <col class="data-col-8">
                        <col class="data-col-9">
                        <col class="data-col-10">
                        <col class="data-col-11">
                    </colgroup>

                    <!-- thead para IMPRESIÓN (repetido en cada página) -->
                    <thead class="print-only">
                        <tr>
                            <th rowspan="2" style="vertical-align:middle;">Proveedor</th>
                            <th rowspan="2" style="vertical-align:middle;">Descripción</th>
                            <th rowspan="2" style="vertical-align:middle;">Fecha Pedido</th>
                            <th rowspan="2" style="vertical-align:middle;">Comprador</th>
                            <th rowspan="2" style="vertical-align:middle;">Medio pedido</th>
                            <th rowspan="2" style="vertical-align:middle;">Edificio</th>
                            <th rowspan="2" style="vertical-align:middle;">Solicitante</th>
                            <th rowspan="2" style="vertical-align:middle;">GDC</th>
                            <th colspan="2" class="text-center">AUTORIZADO</th>
                            <th rowspan="2" class="text-right" style="vertical-align:middle;">Importe<br>s/iva</th>
                        </tr>
                        <tr>
                            <th class="text-center">SI</th>
                            <th class="text-center">NO</th>
                        </tr>
                    </thead>

                    <tbody id="orders-tbody"><!-- filas por JS --></tbody>
                </table>
            </div>
        </div>

        <div id="loading" style="text-align:center; padding:12px; flex:0 0 auto;">
            <div class="spinner"
                style="border:4px solid #f3f3f3; border-top:4px solid #2563eb; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; display:inline-block;">
            </div>
            <p style="margin:8px 0 0;">Cargando pedidos pendientes...</p>
        </div>

        <div id="no-data" style="display:none; text-align:center; padding:12px; color:#666; flex:0 0 auto;">
            No hay pedidos pendientes de autorización.
        </div>
    </div>

    <!-- Modal -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-icon"><span class="material-icons-round" style="font-size:28px;">verified_user</span>
            </div>
            <div class="modal-title">¿Autorizar Pedidos?</div>
            <p class="modal-text">
                Se marcarán como autorizados un total de <strong id="modal-count">0</strong> pedidos.<br>
                Esta acción quedará registrada.
            </p>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn-modal btn-confirm" onclick="confirmAuthorization()">Sí, Autorizar</button>
            </div>
        </div>
    </div>

    <script>
        let currentPendingOrders = [];

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('current-date').textContent = today.toLocaleDateString();
            loadOrders();
        });

        function goBack() { window.top.location.href = APP_URL + '?page=orders_list'; }

        function loadOrders() {
            const btnAuth = document.getElementById('btn-main-auth');

            google.script.run
                .withSuccessHandler(orders => {
                    currentPendingOrders = orders || [];
                    const hasData = currentPendingOrders.length > 0;

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('no-data').style.display = hasData ? 'none' : 'block';
                    btnAuth.disabled = !hasData;

                    renderOrders(currentPendingOrders);
                })
                .withFailureHandler(err => {
                    document.getElementById('loading').innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
                })
                .getPendingOrders();
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('orders-tbody');
            tbody.innerHTML = '';

            (orders || []).forEach(order => {
                const tr = document.createElement('tr');
                const dateStr = order['Fecha Pedido'] ? new Date(order['Fecha Pedido']).toLocaleDateString() : '';

                tr.innerHTML = `
          <td>${order['Proveedor'] || ''}</td>
          <td>${order['Descripción'] || ''}</td>
          <td>${dateStr}</td>
          <td>${order['Comprador'] || ''}</td>
          <td>${order['Medio Pedido'] || ''}</td>
          <td>${order['Edificio'] || ''}</td>
          <td>${order['Solicitante'] || ''}</td>
          <td>${order['GDC_PINV'] || ''}</td>
          <td class="text-center"><div style="width:12px;height:12px;border:1px solid #000;margin:0 auto;background:#fff;"></div></td>
          <td class="text-center"><div style="width:12px;height:12px;border:1px solid #000;margin:0 auto;background:#fff;"></div></td>
          <td class="text-right">${order['Importe'] || ''}</td>
        `;
                tbody.appendChild(tr);
            });
        }

        function openModal() {
            if (currentPendingOrders.length === 0) return;
            document.getElementById('modal-count').textContent = currentPendingOrders.length;
            document.getElementById('auth-modal').classList.add('active');
        }
        function closeModal() { document.getElementById('auth-modal').classList.remove('active'); }
        document.getElementById('auth-modal').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });

        function confirmAuthorization() {
            const confirmBtn = document.querySelector('.btn-confirm');
            const originalText = confirmBtn.textContent;

            confirmBtn.textContent = 'Procesando...';
            confirmBtn.disabled = true;

            const ids = currentPendingOrders.map(o => o['Id_Pedido']);

            google.script.run
                .withSuccessHandler(res => {
                    closeModal();
                    confirmBtn.textContent = originalText;
                    confirmBtn.disabled = false;

                    document.getElementById('loading').style.display = 'block';
                    document.querySelector('#orders-tbody').innerHTML = '';

                    loadOrders(); // recargar
                })
                .withFailureHandler(err => {
                    alert('Error: ' + err.message);
                    confirmBtn.textContent = originalText;
                    confirmBtn.disabled = false;
                    closeModal();
                })
                .markOrdersAsAuthorized(ids);
        }

        // Spinner keyframes
        const style = document.createElement('style');
        style.textContent = `@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}`;
        document.head.appendChild(style);
    </script>
</body>

</html>