<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>Configuraci√≥n de Datos Auxiliares</title>
  <?!= include('css'); ?>
  <style>
    /* Ajustes m√≠nimos (respetando tu est√©tica de tarjeta + tabs) */
    .page { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px 16px 8px; }
    .header { display: flex; align-items: center; gap: 14px; margin-bottom: 6px; }
    .back { color: #374151; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
    .title { font-size: 1.25rem; font-weight: 700; margin-left: auto; margin-right: auto; }

    .tabs { display: flex; gap: 16px; border-bottom: 1px solid #e5e7eb; margin: 12px 0; }
    .tab { padding: 10px 8px; cursor: pointer; color: #374151; border-bottom: 2px solid transparent; font-weight: 600; }
    .tab.active { color: #111827; border-color: #2563eb; }

    .input-row { display: flex; gap: 8px; align-items: center; margin: 12px 0; }
    .input-row input { flex: 1; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 8px; }
    .btn { padding: 8px 12px; border-radius: 8px; cursor: pointer; border: 1px solid #e5e7eb; background: #fff; font-weight: 600; }
    .btn-primary { background: #2563eb; color: #fff; border-color: #2563eb; }
    .btn-danger  { background: #ef4444; color: #fff; border-color: #ef4444; }
    .btn-light   { background: #f3f4f6; color: #374151; }

    .list { display: flex; flex-direction: column; gap: 8px; }
    .item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; }
    .name { font-weight: 500; color: #111827; cursor: text; }
    .muted { color: #6b7280; }

    .edit-row { display: flex; gap: 8px; align-items: center; width: 100%; }
    .edit-row input { flex: 1; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 8px; }
  </style>
</head>

<body>
  <div class="page">
    <div class="card">
      <div class="header">
        <a class="back" href="<?= appUrl ? appUrl + '?page=dashboard' : '#' ?>">‚Üê Volver al Panel</a>
        <div class="title">Configuraci√≥n de Datos Auxiliares</div>
      </div>

      <!-- Pesta√±as -->
      <div class="tabs" id="tabs">
        <div class="tab active" data-type="Compradores"    onclick="selectTab(this)">Compradores</div>
        <div class="tab"         data-type="MediosPedido"   onclick="selectTab(this)">Medios Pedido</div>
        <div class="tab"         data-type="Zonas"          onclick="selectTab(this)">Zonas</div>
        <div class="tab"         data-type="Edificios"      onclick="selectTab(this)">Edificios</div>
        <div class="tab"         data-type="Solicitantes"   onclick="selectTab(this)">Solicitantes</div>
      </div>

      <!-- Caja de alta -->
      <div class="input-row">
        <input id="newValueInput" type="text" placeholder="Nuevo Comprador..." />
        <button class="btn btn-primary" onclick="addCurrent()">A√±adir</button>
      </div>

      <!-- Lista -->
      <div id="list" class="list">
        <div class="muted">Cargando Compradores...</div>
      </div>
    </div>
  </div>

  <?!= include('js'); ?>

  <script>
    // Endpoints expuestos por Code.gs
    const ENDPOINTS = {
      list:   'listAux',
      add:    'addAuxItem',
      update: 'updateAuxItem',
      delete: 'deleteAuxItem'
    };

    const STATE = {
      type: 'Compradores',
      items: [],
      editingId: null
    };

    function selectTab(el) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      STATE.type = el.dataset.type;
      document.getElementById('newValueInput').placeholder = `Nuevo ${el.textContent.trim()}...`;
      loadCurrent();
    }

    function loadCurrent() {
      const list = document.getElementById('list');
      list.innerHTML = `<div class="muted">Cargando ${STATE.type}...</div>`;

      google.script.run
        .withSuccessHandler(data => {
          STATE.items = (Array.isArray(data) ? data : []);
          STATE.editingId = null;
          renderList();
        })
        .withFailureHandler(err => {
          console.error(err);
          list.innerHTML = `<div class="muted">Error al cargar ${STATE.type}.</div>`;
        })[ENDPOINTS.list](STATE.type);
    }

    function addCurrent() {
      const inp = document.getElementById('newValueInput');
      const value = (inp.value || '').trim();
      if (!value) { inp.focus(); return; }

      google.script.run
        .withSuccessHandler(() => { inp.value = ''; loadCurrent(); })
        .withFailureHandler(err => { console.error(err); alert('No se pudo crear el registro.'); })
        [ENDPOINTS.add](STATE.type, value);
    }

    function deleteItem(id) {
      if (!confirm(`¬øEliminar este registro de ${STATE.type}?`)) return;
      google.script.run
        .withSuccessHandler(() => loadCurrent())
        .withFailureHandler(err => { console.error(err); alert('No se pudo eliminar el registro.'); })
        [ENDPOINTS.delete](STATE.type, id);
    }

    function startEdit(id) {
      STATE.editingId = id;
      renderList();
      const inp = document.querySelector(`input[data-edit-id="${cssEscape(id)}"]`);
      if (inp) inp.focus();
    }

    function saveEdit(id) {
      const inp = document.querySelector(`input[data-edit-id="${cssEscape(id)}"]`);
      const newValue = (inp?.value || '').trim();
      if (!newValue) { inp?.focus(); return; }

      google.script.run
        .withSuccessHandler(() => { STATE.editingId = null; loadCurrent(); })
        .withFailureHandler(err => { console.error(err); alert('No se pudo actualizar el registro.'); })
        [ENDPOINTS.update](STATE.type, id, newValue);
    }

    function cancelEdit() {
      STATE.editingId = null;
      renderList();
    }

    function renderList() {
      const list = document.getElementById('list');
      if (!STATE.items.length) {
        list.innerHTML = `<div class="muted">No hay registros.</div>`;
        return;
      }
      list.innerHTML = STATE.items.map((it, idx) => {
        const id = String(it.id ?? idx);
        const name = String(it.name ?? '');
        const isEditing = String(STATE.editingId) === id;

        if (isEditing) {
          return `
            <div class="item" data-id="${escapeHTML(id)}">
              <div class="edit-row">
                <input type="text" value="${escapeAttr(name)}" data-edit-id="${escapeAttr(id)}" />
                <div class="actions">
                  <button class="btn btn-primary" onclick="saveEdit('${escapeAttr(id)}')">Guardar</button>
                  <button class="btn btn-light"   onclick="cancelEdit()">Cancelar</button>
                </div>
              </div>
            </div>
          `;
        }
        return `
          <div class="item" data-id="${escapeHTML(id)}">
            <div class="name" onclick="startEdit('${escapeAttr(id)}')" title="Editar">${escapeHTML(name)}</div>
            <div class="actions">
              <button class="btn btn-danger" onclick="deleteItem('${escapeAttr(id)}')" title="Eliminar">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Utilidades b√°sicas
    function escapeHTML(str) {
      return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }
    function escapeAttr(str) {
      return String(str)
        .replaceAll('&','&amp;').replaceAll('"','&quot;').replaceAll("'",'&#39;')
        .replaceAll('<','&lt;').replaceAll('>','&gt;');
    }
    function cssEscape(str) { return String(str).replace(/["'\\]/g, '\\$&'); }

    // Carga inicial
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('newValueInput').placeholder = 'Nuevo Comprador...';
      loadCurrent();
    });
  </script>
</body>
</html>
